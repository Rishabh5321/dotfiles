name: Merge Flake Update

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - main

jobs:
  wait_for_other_workflows:
    runs-on: ubuntu-latest

    steps:
      - name: Check if other workflows are completed
        uses: actions/github-script@v6
        id: check_workflows
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;

            // Fetch all workflow runs for this repo
            const runs = await github.paginate(
              github.rest.actions.listWorkflowRunsForRepo,
              {
                owner: owner,
                repo: repo,
                event: 'pull_request',
                branch: 'main'
              }
            );

            // Filter the runs for the current pull request
            const currentPRRuns = runs.filter(run => run.pull_requests.some(pr => pr.number === pull_number));

            // Check if all workflow runs for the current PR are successful
            const isSuccess = currentPRRuns.every(run => run.conclusion === 'success');

            if (!isSuccess) {
              core.setFailed('Not all workflows have succeeded.');
            } else {
              console.log('All workflows are successful.');
            }

  merge_or_close_pr:
    needs: wait_for_other_workflows
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Merge Pull Request
        uses: "peter-evans/merge-pull-request@v3"
        with:
          pull-request-number: ${{ github.event.pull_request.number }}
          merge-method: squash

  close_pr:
    needs: wait_for_other_workflows
    runs-on: ubuntu-latest
    if: failure()

    steps:
      - name: Close Pull Request
        run: |
          gh pr close ${{ github.event.pull_request.number }} --repo ${{ github.repository }}
